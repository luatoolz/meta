describe('loader', function()
  local meta, mcache, loader, module, tl, no
  setup(function()
    meta = require "meta"
    mcache = meta.mcache
    loader = meta.loader
    module = meta.module
    tl = require "testdata.loader"
    no = meta.no
  end)
  it("ok", function()
    assert.is_table(mcache)
    assert.is_table(tl)
    assert.is_not_nil(tl.ok)
    assert.equal('ok', tl.ok.message.data)
    local q = tl.ok
    assert.equal('ok', q.message.data)
  end)
  it("eq meta", function()
    assert.equal(getmetatable(meta), getmetatable(meta.loader))
    assert.equal(getmetatable(require("meta")), getmetatable(mcache.new.loader))
    assert.equal(getmetatable(mcache.new.loader), getmetatable(require("meta")))
    assert.equal(getmetatable(meta), getmetatable(mcache.new.loader))
    assert.equal(getmetatable(require("meta")), getmetatable(loader("meta")))
  end)
  it("eq loader", function()
    assert.equal(loader('testdata/loader/noinit'), loader('testdata/loader/noinit'))
    assert.equal(loader('testdata/req/ok'), loader('testdata/req/ok'))
    assert.equal(loader('testdata/req/ok'), loader(loader('testdata/req/ok')))
  end)
  it("module.loader", function()
    local noinit = loader('testdata/loader/noinit')
    local m = module(noinit)
    assert.is_table(noinit)
    assert.is_table(m)
    assert.equal('ok', noinit.message.data)
    assert.equal('ok', noinit['ok.message'].data)
  end)
  it("req", function()
    local req = require "testdata/req"
    assert.is_table(req)
    assert.is_nil(rawget(req, 'ok'))
    local req_ok = require "testdata/req/ok"
    assert.is_table(req_ok)
--    local loaders = loader
--    assert.is_table(loader["testdata/req/ok"])
    assert.is_table(req)
    assert.is_table(req['ok'])
    assert.equal('ok', req.ok.message.data)
  end)
  it("loader() == loader()", function() assert.equal(loader('testdata/lt'), loader('testdata/lt')) end)
  it("dot", function()
    assert.is_table(tl)
    assert.is_not_nil(tl.dot)
    assert.equal('ok', tl.dot['ok.message'].data)
  end)
  it("noinit", function()
    tl = require "testdata.loader"
    assert.is_not_nil(tl)
    assert.is_table(tl)
    assert.is_not_nil(tl.noinit)
    assert.equal('table', type(tl.noinit))
    assert.is_table(module(tl))
    assert.equal('ok', tl.noinit.message.data)
    assert.equal('ok', tl.noinit['ok.message'].data)
    assert.equal('ok', tl.noinit.message.data)
  end)
  it("regular load + recursive preload", function()
    assert.falsy(module("testdata.webapi").topreload)
    assert.falsy(module("testdata.webapi").torecursive)
    local webapi = loader("testdata.webapi", true, true)
    local webapi2 = module("testdata.webapi").recursive.preload
    assert.equal(true, module("testdata.webapi").topreload)
    assert.equal(true, module(webapi).topreload)
    assert.equal(true, module(webapi2).topreload)
    assert.equal(true, module("testdata.webapi").torecursive)
    assert.equal(true, module(webapi).torecursive)
    assert.equal(true, module(webapi2).torecursive)
    assert.equal(webapi, webapi2)
    assert.equal(webapi, require "testdata.webapi")
  end)
  it("recursive preload", function()
    local webapi = loader("testdata.webapi2", true, true)
    local webapi2 = module("testdata.webapi2").recursive.preload
    assert.equal(true, module("testdata.webapi2").topreload)
    assert.equal(true, module(webapi).topreload)
    assert.equal(true, module(webapi2).topreload)
    assert.equal(true, module("testdata.webapi2").torecursive)
    assert.equal(true, module(webapi).torecursive)
    assert.equal(true, module(webapi2).torecursive)
    assert.equal(webapi, webapi2)
    assert.equal(webapi, require "testdata.webapi2")
  end)
  it("__iter", function()
    local iter = require 'meta.iter'
    assert.has_key('lua/', mcache.pkgdirs)
    assert.has_key('./', mcache.pkgdirs)
    assert.values({'testdata/files'}, no.scan('testdata.files'))
    assert.values({'a', 'b', 'c', 'i'}, iter.map(loader('testdata.files')))
    assert.values({'a', 'b', 'c', 'i'}, {} .. iter(loader('testdata.files')))
    assert.values({'a', 'b', 'c', 'i'}, table() .. iter(loader('testdata.files')))
  end)
  it("__concat", function()
    assert.keys({}, loader('testdata.files'))
    assert.keys({}, loader('testdata.files') .. false)
    assert.keys({}, loader('testdata.files') .. nil)
    assert.keys({}, loader('testdata.files') .. {})
    assert.keys({}, loader('testdata.files') .. table.iter({}))
    assert.keys({}, loader('testdata.files') .. {nil})
    assert.keys({}, loader('testdata.files') .. table.iter({nil}))
    assert.keys({}, loader('testdata.files') .. {'none'})
    assert.keys({}, loader('testdata.files') .. table.iter({'none'}))

    assert.keys({'a'}, loader('testdata.files') + 'a')
    assert.keys({'a', 'b'}, loader('testdata.files') + 'a' + 'b')
    assert.keys({'a', 'b'}, loader('testdata.files') .. {'a', 'b'})
    assert.keys({'a', 'b', 'c'}, loader('testdata.files') .. {'a', 'b', 'c'})
    assert.keys({'a', 'b', 'c', 'i'}, loader('testdata.files') .. true)
    assert.keys({'a', 'b', 'c', 'i'}, loader('testdata.files', true, true))

    assert.keys({'a', 'b', 'c', 'i'}, loader('testdata.files') .. true)
    assert.keys({'a', 'b', 'c', 'i'}, loader('testdata.files') .. false)
    assert.keys({'a', 'b', 'c', 'i'}, loader('testdata.files') .. nil)
    assert.keys({'a', 'b', 'c', 'i'}, loader('testdata.files') .. {})
    assert.keys({'a', 'b', 'c', 'i'}, loader('testdata.files') .. {'i'})
    assert.keys({'a', 'b', 'c', 'i'}, loader('testdata.files') .. {nil})

    assert.keys({'a', 'b', 'c', 'i'}, loader('testdata.files') .. table.iter({'i'}))
    assert.keys({'a', 'b', 'c', 'i'}, loader('testdata.files') .. table.iter({}))
    assert.keys({'a', 'b', 'c', 'i'}, loader('testdata.files') .. table.iter({nil}))
  end)
  it("__mul / __mod", function()
    local tt = function(x) return type(x) end
    local ok = function(x) return x and true or false end
    local isn = function(x) x=x or {}; return type(x[1]) == 'number' end

    assert.equal('nil', tt())

    local ltf = loader('testdata.files')
    assert.same({a='table', b='table', c='table', i='table'}, ltf * tt)

    local l = loader('testdata/assert.d')

    assert.keys({'callable', 'ends', 'instance', 'has_key', 'has_value', 'indexable', 'iterable', 'keys', 'like', 'loader', 'module_name', 'mtname', 'similar', 'type', 'values', 'wrapper'}, l*ok)
    assert.same({callable=true, ends=true, instance=true, has_key=true, has_value=true, indexable=true, iterable=true, keys=true, like=true, loader=true, module_name=true, mtname=true, similar=true, type=true, values=true, wrapper=true}, l*ok)
    assert.same({callable="table", ends="table", instance="table", has_key="table", has_value="table", indexable="table", iterable="table", keys="table", like="table", loader="table", module_name="table", mtname='table', similar="table",
                type="table", values="table", wrapper="table"}, l*tt)
    assert.same({callable=true, ends=false, instance=false, has_key=true, has_value=true, indexable=true, iterable=true,keys=true, like=true, loader=true, module_name=true, mtname=true, similar=true, type=false, values=true, wrapper=true}, l*isn)
    assert.keys({'callable', 'ends', 'instance', 'has_key', 'has_value', 'indexable', 'iterable', 'keys', 'like', 'loader', 'module_name', 'mtname', 'similar', 'type', 'values', 'wrapper'}, l * isn)

    local empty = loader('testdata.init2.dir')
    local def = loader('testdata/assert.d')
    assert.same({}, empty)
    assert.same({}, empty * type)
    assert.is_table(def)
    assert.is_table(def * type)
  end)
  it("handler", function()
    local l = loader('testdata.dir') ^ type
    assert.equal(type, module(l).handler)
    assert.equal('table', l.a)
    assert.equal('function', l.b)
    assert.loader(l.c)
  end)
  it("root", function()
    local root = mcache.root
    assert.equal('meta', root.meta)
  end)
  it("__call", function()
    local callable = loader('testdata/loader/callable')
    assert.equal('loader/callable/func', callable.func())
    assert.equal('loader/callable/table', callable.table())
    assert.is_nil(callable.loader())
    assert.is_nil(callable.noloader())
  end)
end)